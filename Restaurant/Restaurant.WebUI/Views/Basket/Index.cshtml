@using Restaurant.DtoLayer.BasketDtos
@model BasketTotalDto

@{
    ViewData["Title"] = "Sepetim";
    Layout = "~/Views/UI/Index.cshtml";
}

<h2 class="mb-4">🛒 Sepetim</h2>

@if (Model == null || Model.BasketItems == null || !Model.BasketItems.Any())
{
    <div class="alert alert-warning">
        Sepetiniz boş.
    </div>
}
else
{
    <table class="table table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th>Ürün</th>
                <th>Görsel</th>
                <th>Adet</th>
                <th>Birim Fiyat</th>
                <th>Toplam</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.BasketItems)
            {
                <tr>
                    <td>@item.ProductName</td>
                    <td>
                        <img src="@item.ProductImageUrl" style="width:60px;height:60px;object-fit:cover;" />
                    </td>
                    <td>@item.Quantity</td>
                    <td>@item.Price ₺</td>
                    <td>@(item.Price* item.Quantity) ₺</td>
                    <td>
                        <a asp-controller="Basket" asp-action="RemoveBasketItem" asp-route-id="@item.ProductId" class="btn btn-sm btn-danger">Sil</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (ViewBag.ExpireTimestamp != null)
    {
        <div class="alert alert-info">
            Kalan Süre: <strong id="timer">--:--</strong>
        </div>

        <script>
            var target = @ViewBag.ExpireTimestamp;
            var interval = setInterval(function() {
                var diff = target - new Date().getTime();
                if (diff <= 0) {
                    clearInterval(interval);
                    location.reload(); // Süre bitince sayfayı yenile, Controller indirimi silsin
                } else {
                    var m = Math.floor(diff / 60000);
                    var s = Math.floor((diff % 60000) / 1000);
                    document.getElementById("timer").innerHTML = m + ":" + (s < 10 ? "0" : "") + s;
                }
            }, 1000);
        </script>
    }

    <div class="card shadow-sm border-4 mt-4">
        <div class="card-body">
            <h5 class="card-title mb-4">Ödeme Özeti</h5>

            <div class="d-flex justify-content-between mb-2">
                <span>Menü Toplam Tutarı:</span>
                <span>@ViewBag.MenuTotal.ToString("N2") ₺</span>
            </div>

            @if (Model.DiscountRate.HasValue && Model.DiscountRate > 0)
            {
                <div class="d-flex justify-content-between mb-2 text-success fw-bold">
                    <span>İndirim (@Model.DiscountRate%):</span>
                    <span>-@ViewBag.Discount.ToString("N2") ₺</span>
                </div>
            }

            <hr />

            <div class="d-flex justify-content-between mb-2 fw-bold text-secondary">
                <span>Ara Toplam (KDV Hariç):</span>
                <span>@ViewBag.SubTotal.ToString("N2") ₺</span>
            </div>

            <div class="d-flex justify-content-between mb-2 text-muted">
                <span>KDV (%10):</span>
                <span>@ViewBag.Tax.ToString("N2") ₺</span>
            </div>

            <hr class="my-3" />

            <div class="d-flex justify-content-between align-items-center">
                <span class="h5 mb-0">Genel Toplam:</span>
                <span class="h4 mb-0 text-primary fw-bold">
                    @ViewBag.FinalTotal.ToString("N2") ₺
                </span>
            </div>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-body">
            <form asp-controller="Basket" asp-action="ApplyDiscount" method="post" class="d-flex gap-2">
                <input type="text" name="code" class="form-control" placeholder="İndirim kodu giriniz" required />
                <button class="btn btn-success">Uygula</button>
            </form>
        </div>
    </div>
}

<div class="mt-4 text-center">
    <a asp-controller="Menu" asp-action="Index" class="btn btn-primary">Alışverişe Devam Et</a>
    <a asp-controller="Order" asp-action="Checkout" class="btn btn-success ms-2">Siparişi Tamamla</a>
</div>

